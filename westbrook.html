<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <link href="http://getbootstrap.com/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="http://getbootstrap.com/examples/justified-nav/justified-nav.css" rel="stylesheet">
  <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-2.0.3.min.js"></script>
  <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <style>
    .label {
      font: 20px Verdana;
    }

    li {
      list-style: none;
      display: 'inline-block';
    }

    .axis text {
      font: 10px sans-serif;
    }

    .axis line,
    .axis path {
      fill: none;
      stroke: #000;
      shape-rendering: crispEdges;
    }

  </style>
</head>
<body>
  <div class="container">
    <div class="row">
      <div class="col-xs-12">
        <svg id="timeline" />        
        <div class="row">
          <div class="col-xs-7">
            <svg id="visualisation" width="700" height="700" />
          </div>
          <div class="col-xs-5">
            Трипл-даблов: <span id="tripleDoubles"></span>
            <ul id="legend">
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
  <br />
  <!--<input type="text" value="81" id="gamesInSeason">
  http://stats.nba.com/stats/leaguegamefinder?Conference=&DateFrom=&DateTo=&Division=&DraftNumber=&DraftRound=&DraftYear=&GB=N&LeagueID=00&Location=&Outcome=&PlayerID=201566&PlayerOrTeam=P&Season=2016-17&SeasonType=Regular+Season&StatCategory=PTS&TeamID=&VsConference=&VsDivision=&VsTeamID=
  <button onclick="return recount();">Пересчитать</button>-->
  <script type="text/javascript">
    function parseDate(input) {
      var parts = input.split('-');
      // new Date(year, month [, day [, hours[, minutes[, seconds[, ms]]]]])
      return new Date(parts[0], parts[1]-1, parts[2]); // Note: months are 0-based
    }

    var vis = d3.select('#visualisation'),
      WIDTH = 900,
      HEIGHT = 300,
      margin = { top: 40, right: 40, bottom: 40, left: 40 },
      width = WIDTH - margin.left - margin.right,
      height = HEIGHT - margin.top - margin.bottom;

    // sample from https://bl.ocks.org/mbostock/4149176
    var customTimeFormat = d3.time.format.multi([
      [".%L", function(d) { return d.getMilliseconds(); }],
      [":%S", function(d) { return d.getSeconds(); }],
      ["%I:%M", function(d) { return d.getMinutes(); }],
      ["%I %p", function(d) { return d.getHours(); }],
      ["%a %d", function(d) { return d.getDay() && d.getDate() != 1; }],
      ["%b %d", function(d) { return d.getDate() != 1; }],
      ["%B", function(d) { return d.getMonth(); }],
      ["%Y", function() { return true; }]
    ]);

    var formatTable = function(d, label, startX, startY, name) {
      var foundLabels = vis.selectAll('.' + label)
        .data(d, function (d) { return d.name + '' + d.value; });
      foundLabels
        .enter()
        .append('text')
        .attr({
          x: startX,
          y: function (di, i) { return startY + i * 20 + (i != 0) * 5; },
          dy: '.35em',
          class: 'label'
        })
        .html(function(di) { return di[name]; });
      foundLabels.exit().remove();
    };

    var data = null;

    var totalGames = 0,
        totalPoints = 0,
        totalRebounds = 0,
        totalAssists = 0,
        totalTD = 0,
        tdStreak = 0,
        nottdStreak = 0;

    var getGamesInfo = function(d) {
      var gamesNumber = d[0].headers.indexOf('MATCHUP')
        , wlNumber = d[0].headers.indexOf('WL')
        , pointsNumber = d[0].headers.indexOf('PTS')
        , reboundsNumber = d[0].headers.indexOf('REB')
        , dateNumber = d[0].headers.indexOf('GAME_DATE')
        , assistsNumber = d[0].headers.indexOf('AST');

      var result = [];
      d[0].rowSet.reverse().forEach(function(game, index) {
        var resultG = {
          id: index,
          name: game[gamesNumber],
          wl: game[wlNumber] == 'Y',
          points: game[pointsNumber],
          rebounds: game[reboundsNumber],
          assists: game[assistsNumber],
          date: parseDate(game[dateNumber]),
          isTD: (game[pointsNumber] >= 10 && game[reboundsNumber] >= 10 && game[assistsNumber] >= 10),
        };

        if (resultG.isTD) {
          if (nottdStreak) {
            nottdStreak = 0;
            tdStreak = 1;
          } else {
            tdStreak += 1;
          }
        } else {
          if (tdStreak) {
            tdStreak = 0;
            nottdStreak = 1;
          } else {
            nottdStreak += 1;
          }
        }

        totalGames += 1;
        totalPoints += resultG.points;
        totalRebounds += resultG.rebounds;
        totalAssists += resultG.assists;
        totalTD += 1 * resultG.isTD;

        resultG.totalGames = totalGames;
        resultG.totalPoints = totalPoints;
        resultG.totalRebounds = totalRebounds;
        resultG.totalAssists = totalAssists;
        resultG.totalTD = totalTD;
        resultG.tdStreak = tdStreak;
        resultG.notTDStreak = nottdStreak;

        result.push(resultG);
      });
      return result;
    }

    var uriPlayer = 'http://stats.nba.com/stats/playercareerstats?LeagueID=00&PerMode=Totals&PlayerID=201566';
    var uriGames = 'http://stats.nba.com/stats/leaguegamefinder?GB=N&LeagueID=00&PlayerID=201566&PlayerOrTeam=P&Season=2016-17&SeasonType=Regular+Season&StatCategory=PTS';
    $(document).ready(function () {
      $.ajax({
        url: uriGames,
        type: 'GET',
        dataType: 'jsonp',
        success: function(result) {
          var gamesDataHeaders = result.resultSets.headers;
          var gamesData = getGamesInfo(result.resultSets);
          var formattedData = getPlayerInfo(data, 82);
          
          $('#tripleDoubles').text(totalTD);

          var xValue = function(d) { return d.date; },
              xScale = d3.time.scale().range([0, width]),
              xMap = function(d) { return xScale(xValue(d)); },
              xAxis = d3.svg.axis().scale(xScale).tickFormat(customTimeFormat);
          xScale.domain([d3.min(gamesData, xValue), d3.max(gamesData, xValue)]);

          var yValue = function(d) { return d.tdStreak || (-1 * d.notTDStreak); },
              yScale = d3.scale.linear().range([height, 0]),
              yMap = function(d) { return yScale(yValue(d)); },
              yAxis = d3.svg.axis().scale(yScale);
          yScale.domain([-1 * d3.max(gamesData, yValue), d3.max(gamesData, yValue)]);

          var svg = d3.select("#timeline")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
            .append("g")
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

          svg.append("g")
              .attr("class", "x axis")
              .attr("transform", "translate(0," + height + ")")
              .call(xAxis);

      //     
      // .attr("class", "dot")
      // 
      // .style("fill", function(d) { return color(cValue(d));}) 
      // .on("mouseover", function(d) {
      //     tooltip.transition()
      //          .duration(200)
      //          .style("opacity", .9);
      //     tooltip.html(d["Cereal Name"] + "<br/> (" + xValue(d) 
	    //     + ", " + yValue(d) + ")")
      //          .style("left", (d3.event.pageX + 5) + "px")
      //          .style("top", (d3.event.pageY - 28) + "px");
      // })
      // .on("mouseout", function(d) {
      //     tooltip.transition()
      //          .duration(500)
      //          .style("opacity", 0);
      // });

          var foundGames = svg
            .selectAll('.game')
            .data(gamesData, function (d) { return d.name + d.date; });

          // scatter plot from here
          // http://bl.ocks.org/weiglemc/6185069
          foundGames
            .enter()
            .append('circle')
            .attr({
              'r': 3.5,
              'cx': xMap,
              'cy': yMap,
              'class': 'game',
            })
            // .append('text')
            // .html(function(di) {
            //   return di.name + ':' +
            //     di.points + ':' +
            //     di.rebounds + ':' +
            //     di.assists + ':' +
            //     di.isTD + ':' +
            //     di.tdStreak + ':' +
            //     di.notTDStreak + ':' +
            //     di.date;
            //   });

          foundGames
            .exit()
            .remove();

          vis
            .append('text')
            .attr({
              x: 30,
              y: 10,
              dy: '.35em',
              class: 'label',
            })
            .html(formattedData.name);

          formatTable(formattedData.total, 'infoTotalLabels', 50, 250, 'name');
          formatTable(formattedData.total, 'infoTotal', 230, 250, 'value');
          
          formatTable(formattedData.perGame, 'infoPerGameLabels', 370, 250, 'name');
          formatTable(formattedData.perGame, 'infoPerGame', 560, 250, 'value');
          
          formatTable(formattedData.leftToScore, 'infoLeftLabels', 50, 370, 'name');
          formatTable(formattedData.leftToScore, 'infoLeft', 230, 370, 'value');
          
          formatTable(formattedData.rythm, 'infoRythmLabels', 370, 370, 'name');
          formatTable(formattedData.rythm, 'infoRythm', 560, 370, 'value');

          formatTable(formattedData.perGameLeft, 'infoPerGameLeftLabels', 50, 490, 'name');
          formatTable(formattedData.perGameLeft, 'infoPerGameLeft', 230, 490, 'value');

        },
        error: function (xhr, ajaxOptions, thrownError) {
          alert(thrownError);
        },
      });
    });

    var getPlayerInfo = function(d, seasonGames) {
      var result = { name: 'Russell Westbrook' };
      var games = totalGames;
      var points = totalPoints;
      var assists = totalAssists;
      var rebounds = totalRebounds;
      
      result['total'] = [
        { name: 'Игр', value: games },
        { name: 'Очков', value: points },
        { name: 'Передач', value: assists },
        { name: 'Подборов', value: rebounds },
      ];
      result['perGame'] = [
        { name: 'В среднем', value: '' },
        { name: 'Очков', value: (points / games).toFixed(1) },
        { name: 'Передач', value: (assists / games).toFixed(1) },
        { name: 'Подборов', value: (rebounds / games).toFixed(1) },
      ];
      result['leftToScore'] = [
        { name: 'Осталось', value: '' },
        { name: 'Очков', value: Math.max(seasonGames * 10 - points, 0) },
        { name: 'Передач', value: Math.max(seasonGames * 10 - assists, 0) },
        { name: 'Подборов', value: Math.max(seasonGames * 10 - rebounds, 0) },
      ];
      result['rythm'] = [
        { name: 'В том же темпе', value: '' },
        { name: 'Очков', value: Math.floor(seasonGames * points / games) },
        { name: 'Передач', value: Math.floor(seasonGames * assists / games) },
        { name: 'Подборов', value: Math.floor(seasonGames * rebounds / games) },
      ];
      result['perGameLeft'] = [
        { name: 'Нужно в том же темпе за игру', value: '' },
        { name: 'Очков', value: (Math.max(seasonGames * 10 - points, 0) / (seasonGames > games ? seasonGames - games : 1)).toFixed(1) },
        { name: 'Передач', value: (Math.max(seasonGames * 10 - assists, 0) / (seasonGames > games ? seasonGames - games : 1)).toFixed(1) },
        { name: 'Подборов', value: (Math.max(seasonGames * 10 - rebounds, 0) / (seasonGames > games ? seasonGames - games : 1)).toFixed(1) },
      ];
      return result;
    };
  </script>
</body>
</html>