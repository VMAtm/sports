<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <link href="http://getbootstrap.com/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="http://getbootstrap.com/examples/justified-nav/justified-nav.css" rel="stylesheet">
  <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-2.0.3.min.js"></script>
  <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
</head>
<body>
  <div class="container">
    <svg id="visualisation" width="500" height="200" />
  </div>
  <br />
  <input type="text" value="81" id="gamesInSeason">
  <button onclick="return recount();">Пересчитать</button>
  <script type="text/javascript">
    var vis = d3.select('#visualisation'),
      WIDTH = 800,
      HEIGHT = 800;

    var formatTable = function(d, label, startX, startY, name) {
      var foundLabels = vis.selectAll('.' + label)
        .data(d, function (d) { return d.name + '' + d.value; });
      foundLabels
        .enter()
        .append('text')
        .attr({
          x: startX,
          y: function (di, i) { return startY + i * 20; },
          dy: '.35em',
          class: label
        })
        .html(function(di) { return di[name]; });
      foundLabels.exit().remove();
    };

    var data = null;
    var recount = function() {
      var games = $('#gamesInSeason').val() * 1;
      var newData = getPlayerInfo(data, games);
      formatTable(newData.leftToScore, 'infoLeft', 170, 130, 'value');
      formatTable(newData.rythm, 'infoRythm', 410, 130, 'value');
      return true;
    }

    var uri = 'http://stats.nba.com/stats/playercareerstats?LeagueID=00&PerMode=Totals&PlayerID=201566';
    $(document).ready(function () {
      $.ajax({
        url: uri,
        type: 'GET',
        dataType: 'jsonp',
        success: function(result) {
          data = result.resultSets.filter(function(e) { return e.name == 'SeasonTotalsRegularSeason'; });
          
          var formattedData = getPlayerInfo(data, 82);
          vis
            .append('text')
            .attr({
              x: 30,
              y: 10,
              dy: '.35em'
            })
            .html(formattedData.name);

          formatTable(formattedData.total, 'infoTotalLabels', 50, 30, 'name');
          formatTable(formattedData.total, 'infoTotal', 170, 30, 'value');
          formatTable(formattedData.perGame, 'infoPerGameLabels', 290, 30, 'name');
          formatTable(formattedData.perGame, 'infoPerGame', 410, 30, 'value');
          formatTable(formattedData.leftToScore, 'infoLeftLabels', 50, 130, 'name');
          formatTable(formattedData.leftToScore, 'infoLeft', 170, 130, 'value');
          formatTable(formattedData.rythm, 'infoRythmLabels', 290, 130, 'name');
          formatTable(formattedData.rythm, 'infoRythm', 410, 130, 'value');
        },
        error: function() { alert('boo!'); },
        headers: { 'X-Alt-Referer': 'http://stats.nba.com/' }
      });
    });

    var getPlayerInfo = function(d, seasonGames) {
      var result = { name: 'Russell Westbrook' };
      var headers = d[0].headers;
      var seasonNumber = headers.indexOf('SEASON_ID')
        , gamesNumber = headers.indexOf('GP')
        , assistsNumber = headers.indexOf('AST')
        , reboundsNumber = headers.indexOf('REB')
        , pointsNumber = headers.indexOf('PTS');
      var currentSeason = d[0].rowSet.filter(function (e) { return e[seasonNumber] == "2016-17"; })[0];
      var games = currentSeason[gamesNumber];
      var points = currentSeason[pointsNumber];
      var assists = currentSeason[assistsNumber];
      var rebounds = currentSeason[reboundsNumber];
      
      result['total'] = [
        { 'name': 'Игр', 'value': games },
        { 'name': 'Очков', 'value': points },
        { 'name': 'Передач', 'value': assists },
        { 'name': 'Подборов', 'value': rebounds },
      ];
      result['perGame'] = [
        { 'name': 'В среднем', 'value': '' },
        { 'name': 'Очков', 'value': (points / games).toFixed(1) },
        { 'name': 'Передач', 'value': (assists / games).toFixed(1) },
        { 'name': 'Подборов', 'value': (rebounds / games).toFixed(1) },
      ];
      result['leftToScore'] = [
        { 'name': 'Осталось', 'value': '' },
        { 'name': 'Очков', 'value': seasonGames * 10 - points },
        { 'name': 'Передач', 'value': seasonGames * 10 - assists },
        { 'name': 'Подборов', 'value': seasonGames * 10 - rebounds },
      ];
      result['rythm'] = [
        { 'name': 'В том же темпе', 'value': '' },
        { 'name': 'Очков', 'value': Math.floor(seasonGames * points / games) },
        { 'name': 'Передач', 'value': Math.floor(seasonGames * assists / games) },
        { 'name': 'Подборов', 'value': Math.floor(seasonGames * rebounds / games) },
      ];
      return result;
    };
  </script>
</body>
</html>